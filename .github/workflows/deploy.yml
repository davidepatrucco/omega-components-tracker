name: Deploy to Lightsail

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # üîë Configura credenziali AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # üîë Login a ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # üì¶ Set TAG in base al branch
      - name: Set image tag
        id: vars
        run: |
          # Tag principale per ambiente
          if [ "${GITHUB_REF}" = "refs/heads/staging" ]; then
            echo "TAG=staging" >> $GITHUB_ENV
            echo "EXTRA_TAG=staging-${GITHUB_SHA::8}" >> $GITHUB_ENV
          else
            echo "TAG=latest" >> $GITHUB_ENV
            echo "EXTRA_TAG=prod-${GITHUB_SHA::8}" >> $GITHUB_ENV
          fi

      # üî® Build & Push Backend
      - name: Build & Push backend
        uses: docker/build-push-action@v5
        with:
          context: ./omega-app/backend
          file: ./omega-app/backend/Dockerfile
          push: true
          build-args: |
            MONGO_URI=${{ github.ref == 'refs/heads/staging' && secrets.MONGO_URI_STAGE || secrets.MONGO_URI_PROD }}
            AZURE_STORAGE_ACCOUNT=${{ github.ref == 'refs/heads/staging' && secrets.AZURE_STORAGE_ACCOUNT_STAGE || secrets.AZURE_STORAGE_ACCOUNT }}
            AZURE_STORAGE_KEY=${{ github.ref == 'refs/heads/staging' && secrets.AZURE_STORAGE_KEY_STAGE || secrets.AZURE_STORAGE_KEY }}
            AZURE_FILE_SHARE=${{ github.ref == 'refs/heads/staging' && secrets.AZURE_FILE_SHARE_STAGE || secrets.AZURE_FILE_SHARE }}
            PORT=4000
          tags: |
            152485877259.dkr.ecr.us-east-1.amazonaws.com/omega-components-tracker-backend:${{ env.TAG }}
            152485877259.dkr.ecr.us-east-1.amazonaws.com/omega-components-tracker-backend:${{ env.EXTRA_TAG }}

      # üî® Build & Push Frontend
      - name: Build & Push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./omega-app/frontend
          file: ./omega-app/frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_URL=${{ github.ref == 'refs/heads/staging' && 'https://api.staging.omega.intellitude.com' || 'https://api.omega.intellitude.com' }}
          tags: |
            152485877259.dkr.ecr.us-east-1.amazonaws.com/omega-components-tracker-frontend:${{ env.TAG }}
            152485877259.dkr.ecr.us-east-1.amazonaws.com/omega-components-tracker-frontend:${{ env.EXTRA_TAG }}

      # üßπ Cleanup vecchie immagini ECR (mantieni solo ultime 5)
      - name: Cleanup old ECR images
        run: |
          echo "üßπ Pulizia vecchie immagini ECR..."
          
          # Cleanup backend images
          aws ecr list-images \
            --repository-name omega-components-tracker-backend \
            --filter tagStatus=UNTAGGED \
            --query 'imageIds[?imageDigest!=null]' \
            --output json | \
          jq '.[] | select(.imageDigest != null) | .imageDigest' | \
          head -n -5 | \
          xargs -I {} aws ecr batch-delete-image \
            --repository-name omega-components-tracker-backend \
            --image-ids imageDigest={} || true
          
          # Cleanup frontend images  
          aws ecr list-images \
            --repository-name omega-components-tracker-frontend \
            --filter tagStatus=UNTAGGED \
            --query 'imageIds[?imageDigest!=null]' \
            --output json | \
          jq '.[] | select(.imageDigest != null) | .imageDigest' | \
          head -n -5 | \
          xargs -I {} aws ecr batch-delete-image \
            --repository-name omega-components-tracker-frontend \
            --image-ids imageDigest={} || true
          
          echo "‚úÖ Cleanup completato"

      # üîë Setup SSH agent (senza salvare file key)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ github.ref == 'refs/heads/staging' && secrets.SSH_KEY_STAGE || secrets.SSH_KEY }}

      # üî• Stop & disable Bitnami stack (Apache, Redis, etc.)
      - name: Disable Bitnami stack on Lightsail
        run: |
          echo "[INFO] Disabilito Bitnami stack (Apache/Redis) su ${{ secrets.SSH_HOST }}..."
          ssh -tt -o StrictHostKeyChecking=no "${{ github.ref == 'refs/heads/staging' && secrets.SSH_USER_STAGE || secrets.SSH_USER }}@${{ github.ref == 'refs/heads/staging' && secrets.SSH_HOST_STAGE || secrets.SSH_HOST }}" "bash -l -c '
            set -euo pipefail
            if [ -x /opt/bitnami/ctlscript.sh ]; then
              echo \"[REMOTE] Stop Bitnami stack...\"
              sudo /opt/bitnami/ctlscript.sh stop || true
            fi
            if systemctl list-unit-files | grep -q bitnami.service; then
              echo \"[REMOTE] Disabilito bitnami.service...\"
              sudo systemctl stop bitnami.service || true
              sudo systemctl disable bitnami.service || true
            fi
            echo \"[REMOTE] Bitnami stack disattivata.\"
          '"

            # üöÄ Deploy su Lightsail
      - name: Run remote docker compose
        run: |
          echo "[INFO] Branch: ${GITHUB_REF}"
          
          if [ "${GITHUB_REF}" = "refs/heads/staging" ]; then
            SSH_HOST="${{ secrets.SSH_HOST_STAGE }}"
            SSH_USER="${{ secrets.SSH_USER_STAGE }}"
            echo "[INFO] Deploy su STAGING: SSH_HOST=$SSH_HOST, SSH_USER=$SSH_USER"
          else
            SSH_HOST="${{ secrets.SSH_HOST }}"
            SSH_USER="${{ secrets.SSH_USER }}"
            echo "[INFO] Deploy su PRODUCTION: SSH_HOST=$SSH_HOST, SSH_USER=$SSH_USER"
          fi

          # decide which branch to deploy (expanded before ssh)
          if [ "${GITHUB_REF}" = "refs/heads/staging" ]; then
            DEPLOY_BRANCH=staging
          else
            DEPLOY_BRANCH=main
          fi

          # Validate SSH parameters before opening the connection
          if [ -z "${SSH_USER:-}" ] || [ -z "${SSH_HOST:-}" ]; then
            echo "[ERROR] SSH_USER or SSH_HOST is empty. Aborting deploy."
            if [ -z "${SSH_USER:-}" ]; then echo "[ERROR] SSH_USER is empty"; fi
            if [ -z "${SSH_HOST:-}" ]; then echo "[ERROR] SSH_HOST is empty"; fi
            exit 1
          fi

          echo "[INFO] Avvio SSH verso $SSH_USER@$SSH_HOST con TAG=${TAG}..."
          ssh -tt -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "bash -l -c \"
            set -euo pipefail
                        
            set -x
            echo '[REMOTE] Inizio deploy su \$(hostname) come utente \$(whoami)'
                        
            echo '[REMOTE] Verifica Docker...'
            if ! command -v docker >/dev/null 2>&1; then
              echo '[REMOTE] Rimozione repo Docker non valido (noble)...'
              sudo sed -i '/download.docker.com.*noble/d' /etc/apt/sources.list
              sudo sed -i '/download.docker.com.*noble/d' /etc/apt/sources.list.d/*.list 2>/dev/null || true
              echo '[REMOTE] Installazione Docker via apt-get...'
              sudo apt-get update && sudo apt-get install -y docker.io && sudo usermod -aG docker $USER
              if ! command -v docker >/dev/null 2>&1; then
                echo '[REMOTE] Fallback: installazione Docker via get.docker.com...'
                curl -fsSL https://get.docker.com | sudo sh
                sudo usermod -aG docker $USER
              fi
              echo '[REMOTE] Docker installato: \$(docker --version)'
            else
              echo '[REMOTE] Docker gi√† presente: \$(docker --version)'
            fi

            echo '[REMOTE] Verifica docker compose/plugin...'
            if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
              echo '[REMOTE] Installazione binario legacy docker-compose...'
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo '[REMOTE] docker-compose installato: $([ -x /usr/local/bin/docker-compose ] && /usr/local/bin/docker-compose --version || echo fallito)'
            fi

            echo '[REMOTE] Verifica AWS CLI...'
            if ! command -v aws >/dev/null 2>&1; then
              echo '[REMOTE] Installazione AWS CLI...'
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              sudo ./aws/install
              rm -rf awscliv2.zip aws/
              echo '[REMOTE] AWS CLI installata: $(aws --version)'
            else
              echo '[REMOTE] AWS CLI gi√† presente: $(aws --version)'
            fi
            echo '[REMOTE] Spostamento in /home/$SSH_USER...'
              cd /home/$SSH_USER
              # Ensure repository exists and is on the correct branch. Prefer fetch+reset if present.
              if [ -d "omega-components-tracker/.git" ]; then
                echo "[REMOTE] omega-components-tracker repo found, fetching and resetting to origin/${DEPLOY_BRANCH}"
                cd omega-components-tracker
                git fetch origin || { echo '[REMOTE] ERRORE: git fetch fallito'; exit 1; }
                git reset --hard origin/${DEPLOY_BRANCH} || { echo '[REMOTE] ERRORE: git reset fallito'; exit 1; }
              else
                echo "[REMOTE] Clono repository e checkout branch ${DEPLOY_BRANCH}"
                rm -rf omega-components-tracker
                git clone --branch ${DEPLOY_BRANCH} https://github.com/davidepatrucco/omega-components-tracker.git omega-components-tracker || { echo '[REMOTE] ERRORE: git clone fallito'; exit 1; }
                cd omega-components-tracker
              fi
            echo '[REMOTE] Login a ECR...'
            export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            export AWS_REGION="us-east-1"
            echo '[REMOTE] aws ecr get-login-password output:'
            aws ecr get-login-password --region us-east-1 || { echo '[REMOTE] ERRORE: aws ecr get-login-password fallito'; exit 1; }
            echo '[REMOTE] Eseguo login a docker...'
            aws ecr get-login-password --region us-east-1 | sudo docker login --username AWS --password-stdin 152485877259.dkr.ecr.us-east-1.amazonaws.com || { echo '[REMOTE] ERRORE: docker login fallito'; exit 1; }

            cd /home/$SSH_USER/omega-components-tracker/omega-app/infra
            # Ensure .env exists in the infra directory on the remote host
            touch .env
            echo '[REMOTE] Debug: current dir and files:'
            pwd
            ls -la
            echo '[REMOTE] --- docker-compose.lightsail.yml ---'
            sed -n '1,200p' docker-compose.lightsail.yml || true
            echo '[REMOTE] --- resolved docker compose config ---'
            (sudo docker compose -f docker-compose.lightsail.yml config || sudo docker-compose -f docker-compose.lightsail.yml config) || true
            if docker compose version >/dev/null 2>&1; then
              echo '[REMOTE] Pull immagini Docker...'
              sudo docker compose -f docker-compose.lightsail.yml pull
              echo '[REMOTE] Avvio container...'
              sudo docker compose -f docker-compose.lightsail.yml up -d --no-build
            elif command -v docker-compose >/dev/null 2>&1; then
              echo '[REMOTE] Pull immagini Docker...'
              sudo docker-compose -f docker-compose.lightsail.yml pull
              echo '[REMOTE] Avvio container...'
              sudo docker-compose -f docker-compose.lightsail.yml up -d --no-build
            else
              echo '[REMOTE] ERRORE: Nessun comando docker compose disponibile!'; exit 1
            fi

            echo '[REMOTE] Stato container:'
            sudo docker ps -a
            echo '[REMOTE] Fine deploy.'\""